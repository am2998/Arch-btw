# zrepl quick start for external backup disk (`/dev/sdc`)

This repository now contains a from-scratch bootstrap for a local zrepl setup:

- periodic snapshots on a source ZFS pool
- push replication to a sink dataset on an external disk pool
- automatic replication every hour to the backup pool

This follows the official zrepl quick-start pattern for local snapshots + offline external disk backup.

## Files

- `scripts/bootstrap-zrepl-local-backup.sh`: Creates/validates backup pool + writes `zrepl.yml`.
- `zrepl.yml`: Generated by the script.

## 0) Requirements

- OpenZFS tools (`zpool`, `zfs`) installed
- `zrepl` installed
- A source pool already exists (example: `zroot`)

## 1) Generate config + preview commands (safe dry-run)

```bash
./scripts/bootstrap-zrepl-local-backup.sh --source-pool zroot
```

This will:

- target backup disk `/dev/sdc`
- use backup pool name `backup`
- auto-detect the source dataset currently mounted on `/` (under the source pool)
- generate `./zrepl.yml`
- print the commands it would run for pool import/create + dataset creation

## 2) Apply pool import/dataset setup

```bash
./scripts/bootstrap-zrepl-local-backup.sh --source-pool zroot --backup-pool backup --apply
```

If the pool exists but is exported, the script imports it.
If the pool is missing, the script fails safely unless you explicitly allow creation with `--create-backup-pool`:

```bash
./scripts/bootstrap-zrepl-local-backup.sh --source-pool zroot --backup-pool backup --create-backup-pool --apply
```

`zpool create` on `/dev/sdc` (only when `--create-backup-pool` is used) overwrites existing data on that device.

## 3) Install config + start zrepl

```bash
sudo install -m 0644 zrepl.yml /etc/zrepl/zrepl.yml
sudo zrepl configcheck
sudo systemctl enable --now zrepl
```

If your system does not use systemd, start `zrepl` via your init system.

## 4) Verify and optionally trigger an immediate run

```bash
sudo zrepl status
sudo zrepl signal wakeup backup_hourly
zfs list -t snapshot -o name,creation -s creation
```

The replicated data lands under:

- `backup/zrepl/sink/<client_identity>/<source_path>` (or your selected backup pool)

with `<client_identity>` set to your short hostname by default.

## 5) Optional customizations

```bash
./scripts/bootstrap-zrepl-local-backup.sh \
  --source-pool zroot \
  --source-dataset zroot/ROOT/default \
  --backup-disk /dev/sdc \
  --backup-pool backup \
  --client-identity myhost \
  --config ./zrepl.yml
```

## Notes

- Snapshot + replication are done by `backup_hourly` every 1 hour.
- Sender pruning keeps: 24 hourly, 30 daily, 8 monthly snapshots.
- Receiver pruning keeps: 24 hourly, 30 daily, 12 monthly snapshots.
- Sender additionally keeps `@base` and `@pacman-*`; receiver keeps only `@base` (no `@pacman-*` retention).
